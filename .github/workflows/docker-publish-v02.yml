name: Build, Push and Pull from ACR

on:
  push:
    branches: [ master ]
    paths:
      - 'Dockerfile'   # Solo se activa cuando cambia el Dockerfile
      - 'WebAppj1/**'       # o los directorios relevantes de tu aplicaci贸n

jobs:
  acr-build-push-pull:
    runs-on: ubuntu-latest
    env:
      ACR_IMAGE_NAME: ${{ secrets.ACR_REGISTRY }}/mi-app
      IMAGE_TAG: ${{ github.sha }}

    steps:
      # 1. Obtener c贸digo fuente
      - name: Checkout code
        uses: actions/checkout@v4

      # 3. Autenticaci贸n con Azure Container Registry
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.AZURE_CLIENT_ID }}
          password: ${{ secrets.AZURE_CLIENT_SECRET }}

      # 3. Construir imagen
      - name: Build Docker image
        run: |
          docker build -t ${{ env.ACR_IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./WebAppj1

      # 4. Subir a ACR
      - name: Push Docker image
        run: |
          docker push ${{ env.ACR_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # 5. Verificaci贸n: Extraer imagen
      - name: Pull Docker image
        run: |
          docker pull ${{ env.ACR_IMAGE_NAME }}:${{ env.IMAGE_TAG }}      
